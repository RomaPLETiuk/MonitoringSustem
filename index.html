<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –¥–æ–≤–∫—ñ–ª–ª—è ‚Äî –ó–∞—Ç–∏—à—à—è</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root {
      --bg: #f2f5f8;
      --text: #333;
      --brand-1: #1d976c;
      --brand-2: #93f9b9;
      --card: #fff;
      --muted: #6b7280;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --radius: 14px;
      --sel: #d1fae5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, Arial, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
      display: flex; flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, var(--brand-1), var(--brand-2));
      color: white; padding: 20px 16px; text-align: center;
    }
    header h1 { margin: 4px 0 8px; font-weight: 700; }
    #lastUpdate { opacity: 0.95; }

    .container { width: min(1200px, 95%); margin: 16px auto 24px; }

    /* Tabs */
    .tabs {
      display: flex; gap: 8px; flex-wrap: wrap;
      background: #e8f6ef; border-radius: 12px; padding: 8px;
      box-shadow: var(--shadow);
    }
    .tab-btn {
      padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer;
      background: transparent; color: #0b5138; font-weight: 600;
    }
    .tab-btn.active { background: #ffffff; color: var(--brand-1); box-shadow: var(--shadow); }
    .tab-content { display: none; padding: 18px; }
    .tab-content.active { display: block; }

    /* Cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
    .card {
      background: var(--card); border-radius: var(--radius);
      padding: 14px; box-shadow: var(--shadow); text-align: center;
      transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, outline-color .12s ease;
      cursor: default;
    }
    .metric-card { cursor: pointer; outline: 2px solid transparent; }
    .metric-card:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .metric-card.selected { background: var(--sel); outline-color: #34d399; }

    .card .label { color: var(--muted); font-size: 13px; }
    .card .value { font-size: 22px; font-weight: 700; margin-top: 6px; }

    .good { color: #16a34a; } .medium { color: #eab308; } .bad { color: #ef4444; }

    .section-title { margin: 6px 0 14px; font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 8px; }

    .wrap { display: grid; gap: 16px; grid-template-columns: 1.2fr 1fr; }
    @media (max-width: 1024px) { .wrap { grid-template-columns: 1fr; } }

    .panel { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; }

    .chart-panel-header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; margin: 0 0 8px; }
    .chart-title { font-weight: 700; }
    .chart-sub { color: var(--muted); font-size: 12px; }

    canvas { max-width: 100%; height: 340px !important; border-radius: 10px; }

    /* Map */
    #map { height: 440px; border-radius: var(--radius); box-shadow: var(--shadow); }

    footer { margin-top: auto; background: var(--brand-1); color: white; text-align: center; padding: 12px; font-size: 14px; }
    footer .small { font-size: 12px; opacity: 0.9; }

    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .error { background: #fee2e2; color: #991b1b; padding: 10px 12px; border-radius: 10px; border: 1px solid #fecaca; }
    .loader { display: inline-flex; align-items: center; gap: 8px; color: var(--muted); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--brand-1); animation: blink 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.2; transform: scale(0.9); } 40% { opacity: 1; transform: scale(1); } }

    .legend { display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px; color: var(--muted); }
    .legend .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: #f3f4f6; border-radius: 999px; }
    .legend .dot-chip { width: 10px; height: 10px; border-radius: 999px; }

    /* Forecast cards */
    .day-cards { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .day {
      display: grid; gap: 6px; justify-items: center;
    }
    .day .day-date { font-weight: 700; }
    .day .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; width: 100%; font-size: 13px; color: var(--muted); }
    .temp-range { font-size: 18px; font-weight: 700; }
    .pop { font-weight: 600; }
    .wx-icon { width: 64px; height: 64px; }
  </style>
</head>
<body>
  <header>
    <h1>üåç –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –¥–æ–≤–∫—ñ–ª–ª—è ‚Äî —Å. –ó–∞—Ç–∏—à—à—è</h1>
    <div id="lastUpdate">–°—Ç–∞–Ω–æ–º –Ω–∞: ‚Äî</div>
  </header>

  <div class="container">
    <!-- Tabs (–ü—Ä–æ–≥–Ω–æ–∑ ‚Äî –¥—Ä—É–≥–æ—é –ø–æ —á–µ—Ä–∑—ñ) -->
    <div class="tabs" role="tablist">
      <button class="tab-btn active" data-tab="panel" role="tab" aria-selected="true">üìä –ü–∞–Ω–µ–ª—å</button>
      <button class="tab-btn" data-tab="forecast" role="tab">üóìÔ∏è –ü—Ä–æ–≥–Ω–æ–∑</button>
      <button class="tab-btn" data-tab="weather" role="tab">üå¶Ô∏è –ü–æ–≥–æ–¥–∞</button>
      <button class="tab-btn" data-tab="air" role="tab">üß™ –Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è</button>
      <button class="tab-btn" data-tab="map" role="tab">üó∫Ô∏è –ú–∞–ø–∞</button>
    </div>

    <!-- ====== TAB: Panel (Overview) ====== -->
    <section id="tab-panel" class="tab-content active" role="tabpanel">
      <div class="wrap">
        <div class="panel">
          <div class="section-title">–ó–≤–µ–¥–µ–Ω–Ω—è (–ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ)</div>
          <div id="panel-cards" class="cards">
            <div class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
          </div>
          <div class="hint">–ü–æ—Ä–∞–¥–∞: –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö ¬´–ü–æ–≥–æ–¥–∞¬ª —Ç–∞ ¬´–Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è¬ª –∫–ª–∞—Ü–∞–π –ø–æ –∫–∞—Ä—Ç–∫–∞—Ö, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ –∑–∞ –Ω–∞–π–±–ª–∏–∂—á—ñ 24 –≥–æ–¥–∏–Ω–∏.</div>
        </div>
        <div class="panel">
          <div class="section-title">–ü–æ—è—Å–Ω–µ–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤</div>
          <div class="legend">
            <span class="chip"><span class="dot-chip" style="background:#16a34a"></span>–î–æ–±—Ä–µ</span>
            <span class="chip"><span class="dot-chip" style="background:#eab308"></span>–°–µ—Ä–µ–¥–Ω—î</span>
            <span class="chip"><span class="dot-chip" style="background:#ef4444"></span>–ü–æ–≥–∞–Ω–æ</span>
          </div>
          <ul>
            <li><b>AQI</b>: 1‚Äì2 –¥–æ–±—Ä–µ, 3 —Å–µ—Ä–µ–¥–Ω—î, 4‚Äì5 –ø–æ–≥–∞–Ω–æ.</li>
            <li><b>PM2.5</b>: &lt;12 ‚Äî –¥–æ–±—Ä–µ, 12‚Äì35 ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ, &gt;35 ‚Äî –ø–æ–≥–∞–Ω–æ.</li>
            <li><b>PM10</b>: &lt;50 ‚Äî –¥–æ–±—Ä–µ, 50‚Äì100 ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ, &gt;100 ‚Äî –ø–æ–≥–∞–Ω–æ.</li>
            <li><b>–í—ñ—Ç–µ—Ä</b>: 0‚Äì5 –º/—Å ‚Äî –ª–µ–≥–∫–∏–π, &gt;10 –º/—Å ‚Äî —Å–∏–ª—å–Ω–∏–π.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ====== TAB: Forecast (Daily cards) ====== -->
    <section id="tab-forecast" class="tab-content" role="tabpanel">
      <div class="panel">
        <div class="section-title">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á—ñ –¥–Ω—ñ</div>
        <div id="forecast-cards" class="day-cards">
          <div class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> –§–æ—Ä–º—É—é –¥–µ–Ω–Ω—ñ –∑–≤–µ–¥–µ–Ω–Ω—è‚Ä¶</div>
        </div>
        <div class="hint">–ë–µ–∑ –ø–ª–∞—Ç–Ω–æ—ó –ø—ñ–¥–ø–∏—Å–∫–∏ OpenWeather –Ω–∞–¥–∞—î –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ <b>5 –¥–Ω—ñ–≤</b> –∑ –∫—Ä–æ–∫–æ–º 3 –≥–æ–¥–∏–Ω–∏ (–∞–≥—Ä–µ–≥–æ–≤–∞–Ω–æ –ø–æ –¥–Ω—è—Ö –Ω–∏–∂—á–µ).</div>
      </div>
    </section>

    <!-- ====== TAB: Weather ====== -->
    <section id="tab-weather" class="tab-content" role="tabpanel">
      <div class="wrap">
        <div class="panel">
          <div class="section-title">–ü–æ—Ç–æ—á–Ω–∞ –ø–æ–≥–æ–¥–∞</div>
          <div id="weather-cards" class="cards">
            <div class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
          </div>
        </div>
        <div class="panel">
          <div class="chart-panel-header">
            <div class="chart-title" id="weatherChartTitle">–ì—Ä–∞—Ñ—ñ–∫: ‚Äî</div>
            <div class="chart-sub" id="weatherChartSub">–ö–ª–∞—Ü–Ω—ñ—Ç—å –ø–æ –∫–∞—Ä—Ç—Ü—ñ –≤–∏—â–µ, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</div>
          </div>
          <canvas id="weatherChart"></canvas>
          <div class="hint">–î–∞–Ω—ñ –∑ OpenWeather ¬´5 day / 3 hour¬ª. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞–π–±–ª–∏–∂—á—ñ ~24 –≥–æ–¥–∏–Ω–∏ (8 —Ç–æ—á–æ–∫, –∫—Ä–æ–∫ 3 –≥–æ–¥).</div>
        </div>
      </div>
    </section>

    <!-- ====== TAB: Air Quality ====== -->
    <section id="tab-air" class="tab-content" role="tabpanel">
      <div class="wrap">
        <div class="panel">
          <div class="section-title">–ü–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ —è–∫–æ—Å—Ç—ñ –ø–æ–≤—ñ—Ç—Ä—è</div>
          <div id="air-cards" class="cards">
            <div class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
          </div>
        </div>
        <div class="panel">
          <div class="chart-panel-header">
            <div class="chart-title" id="airChartTitle">–ì—Ä–∞—Ñ—ñ–∫: ‚Äî</div>
            <div class="chart-sub" id="airChartSub">–ö–ª–∞—Ü–Ω—ñ—Ç—å –ø–æ –∫–∞—Ä—Ç—Ü—ñ –≤–∏—â–µ, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</div>
          </div>
          <canvas id="airChart"></canvas>
          <div class="hint">–ü—Ä–æ–≥–Ω–æ–∑ OpenWeather Air Pollution (—â–æ–≥–æ–¥–∏–Ω–∏). –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞–π–±–ª–∏–∂—á—ñ 24 –≥–æ–¥–∏–Ω–∏.</div>
        </div>
      </div>
    </section>

    <!-- ====== TAB: Map ====== -->
    <section id="tab-map" class="tab-content" role="tabpanel">
      <div class="panel">
        <div class="section-title">–õ–æ–∫–∞—Ü—ñ—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É: —Å. –ó–∞—Ç–∏—à—à—è</div>
        <div id="map"></div>
      </div>
    </section>
  </div>

  <footer>
    <div>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: <b>–†–æ–º–∞–Ω –ü–ª–µ—Ç—é–∫</b></div>
    <div class="small">¬© 2026 ‚Ä¢ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –¥–æ–≤–∫—ñ–ª–ª—è ‚Ä¢ –ù–∞–≤—á–∞–ª—å–Ω–∏–π/—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π –ø—Ä–æ—î–∫—Ç</div>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --------- –ö–û–ù–§–Ü–ì ---------
    const lat = 50.025568493528525;
    const lon = 25.551977585581156;
    const API_KEY = "c91234ddc97f9cf6bb58824bdac07bf3";

    const lastUpdateDiv = document.getElementById("lastUpdate");
    const panelCards = document.getElementById("panel-cards");
    const weatherCards = document.getElementById("weather-cards");
    const airCards = document.getElementById("air-cards");
    const forecastCards = document.getElementById("forecast-cards");

    const weatherChartTitle = document.getElementById("weatherChartTitle");
    const weatherChartSub   = document.getElementById("weatherChartSub");
    const airChartTitle     = document.getElementById("airChartTitle");
    const airChartSub       = document.getElementById("airChartSub");

    let weatherChartInstance = null;
    let airChartInstance = null;

    // –ö–µ—à –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤
    let weatherForecastCache = null; // api /forecast
    let airForecastCache = null;     // api /air_pollution/forecast

    // --------- –ß–ê–° –û–ù–û–í–õ–ï–ù–ù–Ø ---------
    function updateTime() {
      const now = new Date();
      lastUpdateDiv.innerHTML = "–°—Ç–∞–Ω–æ–º –Ω–∞: <b>" + now.toLocaleString('uk-UA') + "</b>";
    }

    // --------- –ö–õ–ê–°–ò –î–õ–Ø AQI ---------
    function aqiText(aqi) {
      return ["", "–î–æ–±—Ä–µ", "–ù–æ—Ä–º–∞–ª—å–Ω–æ", "–°–µ—Ä–µ–¥–Ω—î", "–ü–æ–≥–∞–Ω–æ", "–î—É–∂–µ –ø–æ–≥–∞–Ω–æ"][aqi] || "‚Äî";
    }
    function aqiClass(aqi) {
      if (aqi <= 2) return "good";
      if (aqi === 3) return "medium";
      return "bad";
    }

    // --------- –£–¢–ò–õ–Ü–¢–ò ---------
    const fmtHour = ts => new Date(ts).toLocaleTimeString('uk-UA', { hour: '2-digit' });
    const fmtHourMin = ts => new Date(ts).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
    const safe = v => (v ?? "‚Äî");
    const asRGBA = (hex, a) => {
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
      return `rgba(${r},${g},${b},${a})`;
    };
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    // –ü—Ä–∏–≤–µ–¥–µ–Ω–Ω—è –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ—ó –¥–∞—Ç–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º timeZoneOffset (—Å–µ–∫—É–Ω–¥ –≤—ñ–¥ UTC)
    function ymdKeyFromUTC(dtSec, tzOffsetSec) {
      const local = new Date((dtSec + tzOffsetSec) * 1000);
      const y = local.getUTCFullYear();
      const m = String(local.getUTCMonth() + 1).padStart(2, '0');
      const d = String(local.getUTCDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    function prettyDayFromUTC(dtSec, tzOffsetSec) {
      const local = new Date((dtSec + tzOffsetSec) * 1000);
      return local.toLocaleDateString('uk-UA', { weekday: 'short', day: '2-digit', month: 'short' });
    }

    // --------- –¢–ê–ë–ò ---------
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = {
      panel: document.getElementById("tab-panel"),
      forecast: document.getElementById("tab-forecast"),
      weather: document.getElementById("tab-weather"),
      air: document.getElementById("tab-air"),
      map: document.getElementById("tab-map"),
    };

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        Object.values(tabContents).forEach(el => el.classList.remove("active"));
        btn.classList.add("active");
        const id = btn.dataset.tab;
        tabContents[id].classList.add("active");
        // –õ—ñ–Ω–∏–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        if (id === "forecast") ensureForecastLoaded();
        if (id === "weather") ensureWeatherLoaded();
        if (id === "air") ensureAirLoaded();
        if (id === "map") ensureMapLoaded();
      });
    });

    // --------- MAP (Leaflet) ---------
    let mapInstance = null; let mapInitialized = false;
    function ensureMapLoaded() {
      if (!mapInitialized) {
        mapInitialized = true;
        mapInstance = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(mapInstance);
        L.marker([lat, lon]).addTo(mapInstance).bindPopup("–ó–∞—Ç–∏—à—à—è").openPopup();
      }
      requestAnimationFrame(() => { mapInstance.invalidateSize(); setTimeout(() => mapInstance.invalidateSize(), 150); });
    }

    // --------- API ---------
    async function fetchJSON(url) { const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json(); }
    async function getWeatherNow() { const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=uk&appid=${API_KEY}`; return await fetchJSON(url); }
    async function getWeatherForecast() { if (weatherForecastCache) return weatherForecastCache; const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=uk&appid=${API_KEY}`; weatherForecastCache = await fetchJSON(url); return weatherForecastCache; }
    async function getAirNow() { const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`; return await fetchJSON(url); }
    async function getAirForecast() { if (airForecastCache) return airForecastCache; const url = `https://api.openweathermap.org/data/2.5/air_pollution/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}`; airForecastCache = await fetchJSON(url); return airForecastCache; }

    // --------- –ú–ï–¢–†–ò–ö–ò ---------
    const WEATHER_METRICS = {
      temp:       { label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',           color: '#ef4444', unit: '¬∞C',  extractor: i => i.main?.temp },
      feels_like: { label: '–í—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è',          color: '#f97316', unit: '¬∞C',  extractor: i => i.main?.feels_like },
      humidity:   { label: '–í–æ–ª–æ–≥—ñ—Å—Ç—å (%)',         color: '#3b82f6', unit: '%',   extractor: i => i.main?.humidity },
      pressure:   { label: '–¢–∏—Å–∫ (–≥–ü–∞)',            color: '#6366f1', unit: '–≥–ü–∞', extractor: i => i.main?.pressure },
      wind:       { label: '–í—ñ—Ç–µ—Ä (–º/—Å)',           color: '#10b981', unit: '–º/—Å', extractor: i => i.wind?.speed },
      clouds:     { label: '–•–º–∞—Ä–Ω—ñ—Å—Ç—å (%)',         color: '#6b7280', unit: '%',   extractor: i => i.clouds?.all },
    };
    const AIR_METRICS = {
      aqi:   { label: 'AQI (1‚Äì5)',     color: '#f59e0b', unit: '',      extractor: i => i.main?.aqi, stepped: true, yMin: 0, yMax: 5 },
      pm2_5: { label: 'PM2.5 (Œº–≥/–º¬≥)', color: '#8b5cf6', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.pm2_5 },
      pm10:  { label: 'PM10 (Œº–≥/–º¬≥)',  color: '#10b981', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.pm10 },
      no2:   { label: 'NO‚ÇÇ (Œº–≥/–º¬≥)',   color: '#ef4444', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.no2 },
      o3:    { label: 'O‚ÇÉ (Œº–≥/–º¬≥)',    color: '#06b6d4', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.o3 },
      so2:   { label: 'SO‚ÇÇ (Œº–≥/–º¬≥)',   color: '#a3e635', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.so2 },
      co:    { label: 'CO (Œº–≥/–º¬≥)',    color: '#f43f5e', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.co },
      nh3:   { label: 'NH‚ÇÉ (Œº–≥/–º¬≥)',   color: '#14b8a6', unit: 'Œº–≥/–º¬≥', extractor: i => i.components?.nh3 },
    };

    // --------- –ü–ê–ù–ï–õ–¨ ---------
    async function loadPanel() {
      try {
        const [wNow, aNow] = await Promise.all([getWeatherNow(), getAirNow()]);
        const sunrise = new Date(wNow.sys.sunrise * 1000).toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'});
        const sunset  = new Date(wNow.sys.sunset  * 1000).toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'});
        const aqi = aNow?.list?.[0]?.main?.aqi ?? 0;
        const c = aNow?.list?.[0]?.components ?? {};

        panelCards.innerHTML = `
          <div class="card" title="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ + –≤—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è">
            <div class="label">üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
            <div class="value">${safe(wNow.main?.temp)} ¬∞C / ${safe(wNow.main?.feels_like)} ¬∞C</div>
          </div>
          <div class="card" title="–í–æ–ª–æ–≥—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è, %">
            <div class="label">üíß –í–æ–ª–æ–≥—ñ—Å—Ç—å</div>
            <div class="value">${safe(wNow.main?.humidity)} %</div>
          </div>
          <div class="card" title="–®–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ—Ç—Ä—É, –º/—Å">
            <div class="label">üå¨ –í—ñ—Ç–µ—Ä</div>
            <div class="value">${safe(wNow.wind?.speed)} –º/—Å</div>
          </div>
          <div class="card" title="–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π —Ç–∏—Å–∫, –≥–ü–∞">
            <div class="label">üîΩ –¢–∏—Å–∫</div>
            <div class="value">${safe(wNow.main?.pressure)} –≥–ü–∞</div>
          </div>
          <div class="card" title="–û–ø–∏—Å –ø–æ—Ç–æ—á–Ω–æ—ó –ø–æ–≥–æ–¥–∏">
            <div class="label">üå§ –û–ø–∏—Å</div>
            <div class="value">${safe(wNow.weather?.[0]?.description)}</div>
          </div>
          <div class="card" title="–ß–∞—Å —Å—Ö–æ–¥—É/–∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è">
            <div class="label">üåÖ –°—Ö—ñ–¥ / –ó–∞—Ö—ñ–¥</div>
            <div class="value">${sunrise} / ${sunset}</div>
          </div>
          <div class="card ${aqiClass(aqi)}" title="AQI (1‚Äì5)">
            <div class="label">üü¢ –Ü–Ω–¥–µ–∫—Å —è–∫–æ—Å—Ç—ñ –ø–æ–≤—ñ—Ç—Ä—è</div>
            <div class="value">${aqiText(aqi)} (${aqi})</div>
          </div>
          <div class="card" title="PM2.5, Œºg/–º¬≥">
            <div class="label">PM2.5</div>
            <div class="value">${safe(c.pm2_5)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card" title="PM10, Œºg/–º¬≥">
            <div class="label">PM10</div>
            <div class="value">${safe(c.pm10)} Œº–≥/–º¬≥</div>
          </div>
        `;
        updateTime();
      } catch (e) { panelCards.innerHTML = `<div class="error">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤–µ–¥–µ–Ω–Ω—è. ${e.message}</div>`; }
    }

    // --------- –ü–û–ì–û–î–ê ---------
    let weatherLoaded = false;
    async function ensureWeatherLoaded() { if (weatherLoaded) return; weatherLoaded = true; await loadWeatherCards(); activateMetricCard('weather', 'temp'); }

    async function loadWeatherCards() {
      try {
        const w = await getWeatherNow();
        const sunrise = new Date(w.sys.sunrise * 1000).toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'});
        const sunset  = new Date(w.sys.sunset  * 1000).toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'});

        weatherCards.innerHTML = `
          <div class="card metric-card" data-group="weather" data-metric="temp" title="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ + –≤—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è">
            <div class="label">üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
            <div class="value">${safe(w.main?.temp)} ¬∞C / ${safe(w.main?.feels_like)} ¬∞C</div>
          </div>
          <div class="card metric-card" data-group="weather" data-metric="humidity" title="–í–æ–ª–æ–≥—ñ—Å—Ç—å, %">
            <div class="label">üíß –í–æ–ª–æ–≥—ñ—Å—Ç—å</div>
            <div class="value">${safe(w.main?.humidity)} %</div>
          </div>
          <div class="card metric-card" data-group="weather" data-metric="pressure" title="–¢–∏—Å–∫, –≥–ü–∞">
            <div class="label">üîΩ –¢–∏—Å–∫</div>
            <div class="value">${safe(w.main?.pressure)} –≥–ü–∞</div>
          </div>
          <div class="card metric-card" data-group="weather" data-metric="wind" title="–®–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ—Ç—Ä—É, –º/—Å">
            <div class="label">üå¨ –í—ñ—Ç–µ—Ä</div>
            <div class="value">${safe(w.wind?.speed)} –º/—Å</div>
          </div>
          <div class="card metric-card" data-group="weather" data-metric="clouds" title="–•–º–∞—Ä–Ω—ñ—Å—Ç—å, %">
            <div class="label">‚òÅÔ∏è –•–º–∞—Ä–Ω—ñ—Å—Ç—å</div>
            <div class="value">${safe(w.clouds?.all)} %</div>
          </div>
          <div class="card" title="–°—Ö—ñ–¥/–ó–∞—Ö—ñ–¥ —Å–æ–Ω—Ü—è">
            <div class="label">üåÖ –°—Ö—ñ–¥ / –ó–∞—Ö—ñ–¥</div>
            <div class="value">${sunrise} / ${sunset}</div>
          </div>
        `;
        attachMetricCardClicks();
        updateTime();
      } catch (e) { weatherCards.innerHTML = `<div class="error">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≥–æ–¥—É. ${e.message}</div>`; }
    }

    async function renderWeatherMetric(metricKey) {
      const ctx = document.getElementById("weatherChart").getContext("2d");
      try {
        const f = await getWeatherForecast();
        const slice = f.list.slice(0, 8); // ~24 –≥–æ–¥–∏–Ω–∏ (–∫—Ä–æ–∫ 3 –≥–æ–¥)
        const labels = slice.map(i => fmtHour(i.dt * 1000));

        if (weatherChartInstance) weatherChartInstance.destroy();

        if (metricKey === 'temp') {
          const temps = slice.map(i => WEATHER_METRICS.temp.extractor(i));
          const feels = slice.map(i => WEATHER_METRICS.feels_like.extractor(i));
          weatherChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [
              { label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)', data: temps, borderColor: '#ef4444', backgroundColor: asRGBA('#ef4444', 0.15), tension: 0.35, pointRadius: 3, pointHoverRadius: 5, fill: false },
              { label: '–í—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è (¬∞C)', data: feels, borderColor: '#f97316', backgroundColor: asRGBA('#f97316', 0.12), tension: 0.35, pointRadius: 3, pointHoverRadius: 5, fill: false },
            ]},
            options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top' } }, scales: { y: { title: { display: true, text: '¬∞C' }, grace: '10%' }, x: { grid: { display: false } } } }
          });
          weatherChartTitle.textContent = '–ì—Ä–∞—Ñ—ñ–∫: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ & –í—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è';
          weatherChartSub.textContent = '–ù–∞–π–±–ª–∏–∂—á—ñ ~24 –≥–æ–¥–∏–Ω–∏ (–∫—Ä–æ–∫ 3 –≥–æ–¥)';
        } else {
          const meta = WEATHER_METRICS[metricKey]; if (!meta) return;
          const data = slice.map(i => meta.extractor(i)).map(v => (v != null ? +v : null));
          weatherChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: meta.label, data, borderColor: meta.color, backgroundColor: asRGBA(meta.color, 0.18), pointRadius: 3, pointHoverRadius: 5, tension: 0.35, fill: true, spanGaps: true }] },
            options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { title: { display: true, text: meta.unit || '' }, ticks: { callback: (v) => meta.unit ? `${v} ${meta.unit}` : v }, grace: '10%' } } }
          });
          weatherChartTitle.textContent = `–ì—Ä–∞—Ñ—ñ–∫: ${meta.label}`;
          weatherChartSub.textContent = '–ù–∞–π–±–ª–∏–∂—á—ñ ~24 –≥–æ–¥–∏–Ω–∏ (–∫—Ä–æ–∫ 3 –≥–æ–¥)';
        }
      } catch (e) {
        document.getElementById("tab-weather").insertAdjacentHTML('beforeend', `<div class="error">–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–±—É–¥—É–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫: ${e.message}</div>`);
      }
    }

    // --------- –ü–†–û–ì–ù–û–ó (–∞–≥—Ä–µ–≥–∞—Ü—ñ—è –ø–æ –¥–Ω—è—Ö) ---------
    let forecastLoaded = false;
    async function ensureForecastLoaded() { if (forecastLoaded) return; forecastLoaded = true; await loadForecastCards(); }

    async function loadForecastCards() {
      try {
        const f = await getWeatherForecast();
        const tzOffset = f.city?.timezone || 0; // —É —Å–µ–∫—É–Ω–¥–∞—Ö
        const byDay = new Map();
        f.list.forEach(item => {
          const key = ymdKeyFromUTC(item.dt, tzOffset);
          const arr = byDay.get(key) || []; arr.push(item); byDay.set(key, arr);
        });
        // –±–µ—Ä–µ–º–æ –º–∞–∫—Å–∏–º—É–º 5 –¥–Ω—ñ–≤
        const keys = Array.from(byDay.keys()).sort().slice(0, 5);
        const days = keys.map(k => {
          const items = byDay.get(k);
          // –≤–∏–±—ñ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–Ω–∏—Ü—å–∫–æ–≥–æ –∑–∞–ø–∏—Å—É –±–ª–∏–∑—å–∫–æ –ø–æ–ª—É–¥–Ω—è (12:00 –ª–æ–∫.)
          let pick = items[0];
          let bestDiff = Infinity;
          items.forEach(i => { const localHour = new Date((i.dt + tzOffset)*1000).getUTCHours(); const diff = Math.abs(localHour - 12); if (diff < bestDiff) { bestDiff = diff; pick = i; } });
          const tempsMin = Math.min(...items.map(i => (i.main?.temp_min ?? i.main?.temp)));
          const tempsMax = Math.max(...items.map(i => (i.main?.temp_max ?? i.main?.temp)));
          const humAvg = Math.round(items.reduce((s,i)=>s+(i.main?.humidity??0),0) / items.length);
          const windMax = Math.max(...items.map(i => (i.wind?.speed ?? 0)));
          const popMax = Math.round(Math.max(...items.map(i => (i.pop ?? 0))) * 100);
          const rainSum = items.reduce((s,i)=> s + (i.rain?.['3h'] ?? 0), 0);
          const snowSum = items.reduce((s,i)=> s + (i.snow?.['3h'] ?? 0), 0);
          const precipSum = +(rainSum + snowSum).toFixed(1);
          const icon = pick.weather?.[0]?.icon || '01d';
          const desc = pick.weather?.[0]?.description || '';
          const pretty = prettyDayFromUTC(items[0].dt, tzOffset);
          return { key: k, pretty, icon, desc, tmin: Math.round(tempsMin), tmax: Math.round(tempsMax), humAvg, windMax: +windMax.toFixed(1), popMax, precipSum };
        });

        forecastCards.innerHTML = days.map(d => `
          <div class="card day" title="${d.desc}">
            <div class="day-date">${d.pretty}</div>
            <img class="wx-icon" alt="ico" src="https://openweathermap.org/img/wn/${d.icon}@2x.png"/>
            <div class="temp-range">${d.tmax}¬∞ / ${d.tmin}¬∞C</div>
            <div class="value" style="margin-top:2px; text-transform: capitalize;">${d.desc}</div>
            <div class="meta">
              <div>üíß ${d.humAvg}%</div>
              <div>üå¨ ${d.windMax} –º/—Å</div>
              <div class="pop">üåßÔ∏è ${d.popMax}%</div>
              <div>‚òî ${d.precipSum} –º–º</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        forecastCards.innerHTML = `<div class="error">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑: ${e.message}</div>`;
      }
    }

    // --------- –ü–û–í–Ü–¢–†–Ø ---------
    let airLoaded = false;
    async function ensureAirLoaded() { if (airLoaded) return; airLoaded = true; await loadAirCards(); activateMetricCard('air', 'pm2_5'); }

    async function loadAirCards() {
      try {
        const d = await getAirNow();
        const aqi = d?.list?.[0]?.main?.aqi ?? 0; const c = d?.list?.[0]?.components ?? {};
        airCards.innerHTML = `
          <div class="card metric-card ${aqiClass(aqi)}" data-group="air" data-metric="aqi" title="AQI: 1‚Äì5">
            <div class="label">üü¢ –Ü–Ω–¥–µ–∫—Å —è–∫–æ—Å—Ç—ñ –ø–æ–≤—ñ—Ç—Ä—è</div>
            <div class="value">${aqiText(aqi)} (${aqi})</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="pm2_5" title="PM2.5, Œºg/–º¬≥">
            <div class="label">PM2.5</div>
            <div class="value">${safe(c.pm2_5)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="pm10" title="PM10, Œºg/–º¬≥">
            <div class="label">PM10</div>
            <div class="value">${safe(c.pm10)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="no2" title="NO‚ÇÇ, Œºg/–º¬≥">
            <div class="label">NO‚ÇÇ</div>
            <div class="value">${safe(c.no2)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="o3" title="O‚ÇÉ, Œºg/–º¬≥">
            <div class="label">O‚ÇÉ</div>
            <div class="value">${safe(c.o3)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="so2" title="SO‚ÇÇ, Œºg/–º¬≥">
            <div class="label">SO‚ÇÇ</div>
            <div class="value">${safe(c.so2)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="co" title="CO, Œºg/–º¬≥">
            <div class="label">CO</div>
            <div class="value">${safe(c.co)} Œº–≥/–º¬≥</div>
          </div>
          <div class="card metric-card" data-group="air" data-metric="nh3" title="NH‚ÇÉ, Œºg/–º¬≥">
            <div class="label">NH‚ÇÉ</div>
            <div class="value">${safe(c.nh3)} Œº–≥/–º¬≥</div>
          </div>
        `;
        attachMetricCardClicks();
        updateTime();
      } catch (e) { airCards.innerHTML = `<div class=\"error\">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —è–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è. ${e.message}</div>`; }
    }

    async function renderAirMetric(metricKey) {
      const meta = AIR_METRICS[metricKey]; if (!meta) return;
      const ctx = document.getElementById("airChart").getContext("2d");
      try {
        const f = await getAirForecast();
        const slice = (f.list || []).slice(0, 24); const labels = slice.map(i => fmtHourMin(i.dt * 1000));
        const data = slice.map(i => meta.extractor(i)).map(v => (v != null ? +v : null));
        if (airChartInstance) airChartInstance.destroy();
        airChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: meta.label, data, borderColor: meta.color, backgroundColor: asRGBA(meta.color, 0.18), pointRadius: 3, pointHoverRadius: 5, tension: meta.stepped ? 0 : 0.35, fill: true, spanGaps: true, stepped: meta.stepped || false }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { title: { display: true, text: meta.unit || '' }, ticks: { callback: (v) => meta.unit ? `${v} ${meta.unit}` : v }, suggestedMin: meta.yMin != null ? meta.yMin : undefined, suggestedMax: meta.yMax != null ? meta.yMax : undefined, grace: '10%' } } } });
        airChartTitle.textContent = `–ì—Ä–∞—Ñ—ñ–∫: ${meta.label}`; airChartSub.textContent = '–ù–∞–π–±–ª–∏–∂—á—ñ 24 –≥–æ–¥–∏–Ω–∏ (—â–æ–≥–æ–¥–∏–Ω–∏)';
      } catch (e) { document.getElementById("tab-air").insertAdjacentHTML('beforeend', `<div class="error">–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–±—É–¥—É–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫: ${e.message}</div>`); }
    }

    // --------- –ö–õ–Ü–ö–ò –ü–û –ö–ê–†–¢–ö–ê–• ---------
    function attachMetricCardClicks() {
      document.querySelectorAll('.metric-card').forEach(card => {
        card.addEventListener('click', () => {
          const group = card.getAttribute('data-group');
          const metric = card.getAttribute('data-metric');
          activateMetricCard(group, metric);
        });
      });
    }
    function activateMetricCard(group, metric) {
      document.querySelectorAll(`.metric-card[data-group="${group}"]`).forEach(c => c.classList.remove('selected'));
      const current = document.querySelector(`.metric-card[data-group="${group}"][data-metric="${metric}"]`);
      if (current) current.classList.add('selected');
      if (group === 'weather') renderWeatherMetric(metric);
      if (group === 'air') renderAirMetric(metric);
    }

    // --------- INIT ---------
    (async function init() { updateTime(); loadPanel(); })();
  </script>
</body>
</html>
